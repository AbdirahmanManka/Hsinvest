{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }} - HasilInvest{% endblock %}
{% block meta_description %}{{ post.excerpt|default:post.content|truncatewords:30 }}{% endblock %}
{% block og_image %}{% if post.featured_image %}{{ post.featured_image.url }}{% endif %}{% endblock %}

{% block content %}
<!-- Post Header -->
<section class="bg-gradient-to-r from-primary-600 to-primary-800 text-white py-20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <div class="mb-6">
            <a href="{% url 'blog:post_list' %}" class="inline-flex items-center text-primary-100 hover:text-white transition-colors mb-4">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Blogs
            </a>
        </div>
        
        <div class="flex items-center justify-center text-sm text-primary-100 mb-6">
            <span class="bg-primary-500 text-white px-3 py-1 rounded-full">
                {{ post.category.name|default:"Uncategorized" }}
            </span>
            <span class="mx-3">•</span>
            <span>{{ post.published_at|date:"F d, Y" }}</span>
            {% if post.views_count %}
            <span class="mx-3">•</span>
            <span class="flex items-center">
                <i class="fas fa-eye mr-1"></i>
                {{ post.views_count }} views
            </span>
            {% endif %}
        </div>
        
        <h1 class="text-3xl md:text-5xl font-bold mb-6 leading-tight">{{ post.title }}</h1>
        
        {% if post.excerpt %}
        <p class="text-xl text-primary-100 max-w-3xl mx-auto">{{ post.excerpt }}</p>
        {% endif %}
        
        <div class="flex items-center justify-center mt-8">
            <div class="w-12 h-12 bg-primary-500 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-user text-white"></i>
            </div>
            <div class="text-left">
                <p class="font-semibold">{{ post.author.get_full_name|default:post.author.username }}</p>
                <p class="text-sm text-primary-200">Author</p>
            </div>
        </div>
    </div>
</section>

<!-- Post Content -->
<section class="py-16 bg-white">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <article class="prose prose-lg max-w-none">
            {% if post.featured_image %}
            <div class="mb-8">
                <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" class="w-full rounded-xl shadow-lg">
            </div>
            {% endif %}
            
            {{ post.content|safe }}
        </article>
        
        <!-- Tags -->
        {% if post.tags.all %}
        <div class="mt-12 pt-8 border-t border-gray-200">
            <h3 class="text-lg font-semibold text-secondary-900 mb-4">Tags</h3>
            <div class="flex flex-wrap gap-2">
                {% for tag in post.tags.all %}
                <a href="{% url 'blog:tag_detail' tag.slug %}" 
                   class="px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-primary-100 hover:text-primary-800 transition-colors">
                    #{{ tag.name }}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Rating Section -->
        <div class="mt-12 pt-8 border-t border-gray-200">
            <h3 class="text-lg font-semibold text-secondary-900 mb-4">Rate this post</h3>
            <div class="flex items-center space-x-4 mb-4">
                <div class="flex items-center">
                    {% for i in "12345" %}
                    <button class="star-rating text-2xl text-gray-300 hover:text-yellow-400 transition-colors" 
                            data-rating="{{ forloop.counter }}" data-post-id="{{ post.id }}">
                        <i class="fas fa-star"></i>
                    </button>
                    {% endfor %}
                </div>
                <span class="text-sm text-secondary-600">
                    {% if average_rating %}
                    {{ average_rating|floatformat:1 }}/5 ({{ rating_count }} ratings)
                    {% else %}
                    No ratings yet
                    {% endif %}
                </span>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="mt-12 pt-8 border-t border-gray-200">
            <div class="flex flex-col sm:flex-row justify-between gap-4">
                {% if previous_post %}
                <a href="{% url 'blog:post_detail' previous_post.slug %}" 
                   class="flex items-center text-primary-600 hover:text-primary-800 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>
                    <div>
                        <span class="text-sm text-secondary-500">Previous Post</span>
                        <p class="font-medium">{{ previous_post.title|truncatechars:50 }}</p>
                    </div>
                </a>
                {% endif %}
                
                {% if next_post %}
                <a href="{% url 'blog:post_detail' next_post.slug %}" 
                   class="flex items-center text-primary-600 hover:text-primary-800 transition-colors sm:text-right">
                    <div>
                        <span class="text-sm text-secondary-500">Next Post</span>
                        <p class="font-medium">{{ next_post.title|truncatechars:50 }}</p>
                    </div>
                    <i class="fas fa-arrow-right ml-2"></i>
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Comments Section -->
<section class="py-16 bg-gray-50">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-secondary-900 mb-8">Comments ({{ comments.count }})</h2>
        
        <!-- Add Comment Form -->
        <div class="bg-white rounded-xl p-6 shadow-md mb-8">
            <h3 class="text-lg font-semibold text-secondary-900 mb-4">Leave a Comment</h3>
            <form method="POST" action="{% url 'blog:add_comment' post.id %}" class="space-y-4">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-secondary-700 mb-2">Name *</label>
                        <input type="text" id="name" name="name" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                               placeholder="Your name">
                    </div>
                    
                    <div>
                        <label for="email" class="block text-sm font-medium text-secondary-700 mb-2">Email *</label>
                        <input type="email" id="email" name="email" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                               placeholder="your.email@example.com">
                    </div>
                </div>
                
                <div>
                    <label for="content" class="block text-sm font-medium text-secondary-700 mb-2">Comment *</label>
                    <textarea id="content" name="content" rows="4" required
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors resize-none"
                              placeholder="Share your thoughts..."></textarea>
                </div>
                
                <div>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Post Comment
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Comments List -->
        {% if comments %}
        <div class="space-y-6">
            {% for comment in comments %}
            <div class="bg-white rounded-xl p-6 shadow-md">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user text-primary-600"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-secondary-900">{{ comment.name }}</h4>
                            <p class="text-sm text-secondary-500">{{ comment.created_at|date:"M d, Y \a\t g:i A" }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="prose prose-sm max-w-none">
                    {{ comment.content|linebreaks }}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-comments text-2xl text-gray-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-secondary-900 mb-2">No comments yet</h3>
            <p class="text-secondary-600">Be the first to share your thoughts on this post!</p>
        </div>
        {% endif %}
    </div>
</section>

<!-- Related Posts -->
{% if related_posts %}
<section class="py-16 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-secondary-900 mb-8 text-center">Related Posts</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            {% for related_post in related_posts %}
            <article class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300 border border-gray-100">
                {% if related_post.featured_image %}
                <img src="{{ related_post.featured_image.url }}" alt="{{ related_post.title }}" class="w-full h-48 object-cover">
                {% else %}
                <div class="w-full h-48 bg-gradient-to-br from-secondary-100 to-secondary-200 flex items-center justify-center">
                    <i class="fas fa-image text-3xl text-secondary-400"></i>
                </div>
                {% endif %}
                
                <div class="p-6">
                    <div class="flex items-center text-sm text-secondary-500 mb-3">
                        <span class="bg-secondary-100 text-secondary-700 px-2 py-1 rounded-full text-xs font-medium">
                            {{ related_post.category.name|default:"Uncategorized" }}
                        </span>
                        <span class="mx-2">•</span>
                        <span>{{ related_post.published_at|date:"M d, Y" }}</span>
                    </div>
                    
                    <h3 class="text-lg font-bold text-secondary-900 mb-3 line-clamp-2">
                        <a href="{% url 'blog:post_detail' related_post.slug %}" class="hover:text-primary-600 transition-colors">
                            {{ related_post.title }}
                        </a>
                    </h3>
                    
                    <p class="text-secondary-600 text-sm mb-4 line-clamp-3">{{ related_post.excerpt|default:related_post.content|truncatewords:15 }}</p>
                    
                    <a href="{% url 'blog:post_detail' related_post.slug %}" class="text-primary-600 hover:text-primary-800 font-medium text-sm">
                        Read More →
                    </a>
                </div>
            </article>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Newsletter CTA -->
<section class="py-16 bg-primary-600 text-white">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">Enjoyed this post?</h2>
        <p class="text-xl text-primary-100 mb-8">Subscribe to get more insights and tutorials delivered to your inbox.</p>
        
        <form method="POST" action="{% url 'newsletter:subscribe' %}" class="max-w-md mx-auto">
            {% csrf_token %}
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="email" name="email" placeholder="Your email address" 
                       class="flex-1 px-4 py-3 rounded-lg text-secondary-900 placeholder-secondary-500 focus:outline-none focus:ring-2 focus:ring-white" required>
                <button type="submit" class="px-6 py-3 bg-white text-primary-600 font-semibold rounded-lg hover:bg-gray-100 transition-colors">
                    Subscribe
                </button>
            </div>
        </form>
        
        <p class="text-sm text-primary-200 mt-4">No spam, unsubscribe at any time.</p>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Star rating functionality
    const starButtons = document.querySelectorAll('.star-rating');
    
    starButtons.forEach(button => {
        button.addEventListener('click', function() {
            const rating = this.dataset.rating;
            const postId = this.dataset.postId;
            
            // Send rating to server
            fetch(`/blog/rate/${postId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `stars=${rating}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI
                    location.reload(); // Simple refresh for now
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while rating the post.');
            });
        });
    });
});
</script>
{% endblock %}
